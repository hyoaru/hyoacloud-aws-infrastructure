AWSTemplateFormatVersion: "2010-09-09"
Description: "Space Layer 000: Managed Policies"

Parameters:
  Environment:
    Type: String
    Description: "The environment name to prefix resource names."
    AllowedValues: [dev, stage, prod]

Conditions:
  IsProd: !Equals [!Ref Environment, "prod"]

Resources:
  IamPassRolePolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub "${Environment}-IAMPassRole"
      Description: "Allows users to assign specific IAM roles to EC2 instances to enable service-to-service permissions."
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: "AllowEC2RoleDelegation"
            Effect: Allow
            Action: "iam:PassRole"
            Resource: !Sub "arn:aws:iam::${AWS::AccountId}:role/${Environment}-*"
  SsmEnvironmentRestrictedPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub "${Environment}-SSMEnvironmentRestricted"
      Description: !Sub "Allows SSM Session Manager access only to ${Environment} instances."
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: "SSMConnectRestrictedToEnvironment"
            Effect: Allow
            Action:
              - "ssm:StartSession"
            Resource:
              - !Sub "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:instance/*"
            Condition:
              StringEquals:
                "aws:ResourceTag/Environment": !Ref Environment
          - Sid: "SSMGeneralActions"
            Effect: Allow
            Action:
              - "ssm:DescribeSessions"
              - "ssm:GetConnectionStatus"
              - "ssm:DescribeInstanceInformation"
              - "ssm:TerminateSession"
              - "ssm:ResumeSession"
            Resource: "*"
  DevOpsConsolidatedPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub "${Environment}-DevOpsConsolidated"
      Description: !Sub "Consolidated DevOps permissions for ${Environment}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          # CloudFormation
          - Sid: "CloudFormationDiscovery"
            Effect: Allow
            Action:
              - "cloudformation:Describe*"
              - "cloudformation:List*"
              - "cloudformation:Get*"
              - "cloudformation:Validate*"
            Resource: "*"
          - Sid: "CloudFormationManagementBase"
            Effect: Allow
            Action:
              - "cloudformation:CreateChangeSet"
              - "cloudformation:ValidateTemplate"
              - "cloudformation:GetTemplateSummary"
            Resource: "*"
          - Sid: "CloudFormationManagementScoped"
            Effect: Allow
            Action:
              - "cloudformation:CreateStack"
              - "cloudformation:UpdateStack"
              - "cloudformation:DeleteStack"
              - "cloudformation:CreateChangeSet"
              - "cloudformation:ExecuteChangeSet"
            Resource:
              - !Sub "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/*${Environment}*/*"
              - !Sub "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/*${Environment}*"
              - !If [
                  IsProd,
                  !Sub "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/core-*/*",
                  !Ref "AWS::NoValue",
                ]
          # IAM
          - Sid: "IamDisovery"
            Effect: "Allow"
            Action:
              - "iam:Get*"
              - "iam:List*"
            Resource: "*"
          # IAM Policy
          - Sid: "IamPolicyManagementScoped"
            Effect: "Allow"
            Action:
              - "iam:CreatePolicy*"
              - "iam:DeletePolicy*"
            Resource:
              - !Sub "arn:aws:iam::${AWS::AccountId}:policy/${Environment}-*"
          # IAM Groups
          - Sid: "IamGroupManagementScoped"
            Effect: "Allow"
            Action:
              - "iam:CreateGroup"
              - "iam:DeleteGroup"
              - "iam:UpdateGroup"
              - "iam:AttachGroupPolicy"
              - "iam:DetachGroupPolicy"
              - "iam:PutGroupPolicy"
              - "iam:DeleteGroupPolicy"
              - "iam:AddUserToGroup"
              - "iam:RemoveUserFromGroup"
            Resource:
              - !Sub "arn:aws:iam::${AWS::AccountId}:group/${Environment}-*"
          # IAM Role
          - Sid: "IamRoleManagementScoped"
            Effect: "Allow"
            Action:
              - "iam:CreateRole"
              - "iam:DeleteRole"
              - "iam:TagRole"
              - "iam:CreateInstanceProfile"
              - "iam:DeleteInstanceProfile"
              - "iam:AttachRolePolicy"
              - "iam:DetachRolePolicy"
              - "iam:AddRoleToInstanceProfile"
              - "iam:RemoveRoleFromInstanceProfile"
            Resource:
              - !Sub "arn:aws:iam::${AWS::AccountId}:role/${Environment}-*"
              - !Sub "arn:aws:iam::${AWS::AccountId}:instance-profile/${Environment}-*"
          # EC2 & Network
          - Sid: "NetworkEc2Discovery"
            Effect: "Allow"
            Action:
              - "ec2:Get*"
              - "ec2:List*"
              - "ec2:Describe*"
            Resource: "*"
          - Sid: "NetworkEc2ManagementBase"
            Effect: "Allow"
            Action:
              - "ec2:CreateTags"
              - "ec2:DeleteTags"
            Resource: "*"
          # Network VPC
          - Sid: "VpcManagementBase"
            Effect: "Allow"
            Action:
              - "ec2:CreateVpc"
              - "ec2:ModifyVpcAttribute"
            Resource: "*"
          - Sid: "VpcManagementScoped"
            Effect: "Allow"
            Action:
              - "ec2:DeleteVpc"
            Resource: "*"
            Condition:
              StringEquals:
                "aws:ResourceTag/Environment": !Ref Environment
          # Network Subnet
          - Sid: "SubnetManagementBase"
            Effect: "Allow"
            Action:
              - "ec2:CreateSubnet"
              - "ec2:ModifySubnetAttribute"
            Resource: "*"
          - Sid: "SubnetManagementScoped"
            Effect: "Allow"
            Action:
              - "ec2:DeleteSubnet"
            Resource: "*"
            Condition:
              StringEquals:
                "aws:ResourceTag/Environment": !Ref Environment
          # Network Internet Gateway
          - Sid: "InternetGatewayManagementBase"
            Effect: "Allow"
            Action:
              - "ec2:CreateInternetGateway"
            Resource: "*"
          - Sid: "InternetGatewayManagementScoped"
            Effect: "Allow"
            Action:
              - "ec2:DeleteInternetGateway"
              - "ec2:AttachInternetGateway"
              - "ec2:DetachInternetGateway"
            Resource: "*"
            Condition:
              StringEquals:
                "aws:ResourceTag/Environment": !Ref Environment
          # Network Route Table
          - Sid: "RouteTableManagementBase"
            Effect: "Allow"
            Action:
              - "ec2:CreateRouteTable"
            Resource: "*"
          - Sid: "RouteTableManagementScoped"
            Effect: "Allow"
            Action:
              - "ec2:DeleteRouteTable"
            Resource: "*"
            Condition:
              StringEquals:
                "aws:ResourceTag/Environment": !Ref Environment
          # Network Subnet Route Table Association
          - Sid: "SubnetRouteTableAssociationManagementScoped"
            Effect: "Allow"
            Action:
              - "ec2:AssociateRouteTable"
              - "ec2:DissociateRouteTable"
            Resource: "*"
            Condition:
              StringEquals:
                "aws:ResourceTag/Environment": !Ref Environment
          # Route
          - Sid: "RouteManagementScoped"
            Effect: "Allow"
            Action:
              - "ec2:CreateRoute"
              - "ec2:DeleteRoute"
              - "ec2:ReplaceRoute"
            Resource: "*"
            Condition:
              StringEquals:
                "aws:ResourceTag/Environment": !Ref Environment
          # Security Group
          - Sid: "SecurityGroupManagementBase"
            Effect: "Allow"
            Action:
              - "ec2:CreateSecurityGroup"
            Resource: "*"
          - Sid: "SecurityGroupManagementScoped"
            Effect: "Allow"
            Action:
              - "ec2:AuthorizeSecurityGroup*"
              - "ec2:RevokeSecurityGroup*"
              - "ec2:UpdateSecurityGroupRuleDescription*"
              - "ec2:DeleteSecurityGroup"
              - "ec2:ModifySecurityGroupRules"
              - "ec2:AssociateSecurityGroupVpc"
              - "ec2:DissociateSecurityGroupVpc"
            Resource: "*"
            Condition:
              StringEquals:
                "aws:ResourceTag/Environment": !Ref Environment
          # Launch Template
          - Sid: "LaunchTemplateManagementBase"
            Effect: "Allow"
            Action:
              - "ec2:CreateLaunchTemplate"
            Resource: "*"
          - Sid: "LaunchTemplateManagementScoped"
            Effect: "Allow"
            Action:
              - "ec2:DeleteLaunchTemplate"
              - "ec2:ModifyLaunchTemplate"
              - "ec2:CreateLaunchTemplateVersion"
              - "ec2:DeleteLaunchTemplateVersion"
            Resource: "*"
            Condition:
              StringEquals:
                "aws:ResourceTag/Environment": !Ref Environment
          # Auto Scaling Group
          - Sid: "AutoScalingDiscovery"
            Effect: "Allow"
            Action:
              - "autoscaling:Describe*"
              - "autoscaling:Get*"
            Resource: "*"
          - Sid: "AutoScalingManagementBase"
            Effect: "Allow"
            Action:
              - "autoscaling:LaunchInstances"
            Resource: "*"
          - Sid: "AutoScalingManagementScoped"
            Effect: "Allow"
            Action:
              - "autoscaling:*AutoScalingGroup"
              - "autoscaling:*LoadBalancers"
              - "autoscaling:*Policy"
              - "autoscaling:*LoadBalancerTargetGroups"
              - "autoscaling:*Processes"
              - "autoscaling:*InstanceRefresh"
              - "autoscaling:*LaunchConfiguration"
              - "autoscaling:*Instances"
              - "autoscaling:*Standby"
              - "autoscaling:*LifecycleAction"
              - "autoscaling:*Tags"
            Resource: "*"
            Condition:
              StringEquals:
                "aws:ResourceTag/Environment": !Ref Environment
          # EC2
          - Sid: "Ec2ManagementBase"
            Effect: "Allow"
            Action:
              - "ec2:RunInstances"
            Resource: "*"
          - Sid: "Ec2ManagementScoped"
            Effect: "Allow"
            Action:
              - "ec2:AssociateIamInstanceProfile"
              - "ec2:RebootInstances"
              - "ec2:StartInstances"
              - "ec2:StopInstances"
              - "ec2:TerminateInstances"
            Resource: "*"
            Condition:
              StringEquals:
                "aws:ResourceTag/Environment": !Ref Environment
          # Cloudwatch
          - Sid: "CloudwatchDiscovery"
            Effect: "Allow"
            Action:
              - "cloudwatch:Get*"
              - "cloudwatch:List*"
              - "cloudwatch:Describe*"
            Resource: "*"

Outputs:
  IamPassRolePolicyArn:
    Description: "ARN of the IamPassRolePolicy"
    Value: !GetAtt "IamPassRolePolicy.PolicyArn"
    Export:
      Name: !Sub "${Environment}-IamPassRolePolicy-arn"
  IamPassRolePolicyId:
    Description: "ID of the IamPassRolePolicy"
    Value: !GetAtt "IamPassRolePolicy.PolicyId"
    Export:
      Name: !Sub "${Environment}-IamPassRolePolicy-id"
  SsmRestrictedPolicyArn:
    Description: "ARN of the SsmEnvironmentRestrictedPolicy"
    Value: !Ref SsmEnvironmentRestrictedPolicy
    Export:
      Name: !Sub "${Environment}-SsmRestrictedPolicy-arn"
  SsmRestrictedPolicyId:
    Description: "ID of the SsmEnvironmentRestrictedPolicy"
    Value: !Ref SsmEnvironmentRestrictedPolicy
    Export:
      Name: !Sub "${Environment}-SsmRestrictedPolicy-id"
  DevOpsConsolidatedPolicyArn:
    Description: "ARN of the DevOpsConsolidatedPolicy"
    Value: !Ref DevOpsConsolidatedPolicy
    Export:
      Name: !Sub "${Environment}-DevOpsConsolidatedPolicy-arn"
  DevOpsConsolidatedPolicyId:
    Description: "ID of the DevOpsConsolidatedPolicy"
    Value: !Ref DevOpsConsolidatedPolicy
    Export:
      Name: !Sub "${Environment}-DevOpsConsolidatedPolicy-id"
